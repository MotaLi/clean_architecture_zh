# 第八章 开闭原则（OCP）

开闭原则由Bertrand Meyer在1988年发明，原则描述为：

> 软件工件应当对扩展开放，对修改关闭

换句话说，软件工件的行为应当是不必修改工件而可扩展的。

当然这也是我们研究软件架构的最基础的原因。显然，如果对需求的简单扩展迫使软件发生巨大的变化，那么该软件系统的架构师就已经犯下了一个惊人的错误。

大多数学习软件设计的学生认识到OCP作为一个原则引导着他们类和模块的设计。但是，但我们考虑架构组件层面，这个原则有着更大的意义。

用个例子会更明白。

## 想法实验

假设此时我们有个财务汇总的web页面的系统。上面的数据是滚动显示的，并且负数将显示成红色。

现在假设利益相关者想把这些同样的信息在黑白打印机打印成报告，这个报告有格式要求，需要有正确的页头，页脚和列标签，负数用括号标注。

很明显，得写新代码了，但老代码得变多少呢？

一个好的软件架构将会把改变得代码总量尽可能降到最低，理论上，一行不变。

怎么做？通过把会由于不同原因变化得事情分割开来（单一职责原则SRP），恰当地组织这些事情得依赖（依赖倒置原则DIP）。

应用SRP，我们可能提出这样得数据流视图如图8.1。一些analyser考察财物数据和产生需要报告的数据，将其交由不同的reporter处理。

这个想法的本质是生成报告设计到两个不同的职责：计算报告数据，数据的web或打印表格的呈现。

做了分离之后，我们需要组织源码的依赖以确保这之中职责的变化不会导致其它组件，并且新的组织确保可以不修改的做扩展。

我们把处理分成了多个类，把这些类分成了多个组件，如图8.2中双线的图表，左上方的是controller，右上方是Interactor，右下方是是Database，最后，左下方的四个组件代表Presenters和Views。



用&lt;I&gt;标记的类表示接口，标记&lt;DS&gt;表示数据结构，人角箭头表示调用关系，三角箭头表示实现或继承关系。

第一件事应该去关注所有的依赖都是源码依赖，从类A执行类B的箭头表示源码里类A用到了类B的名字，但类B没有用到类A的名字。因此，图8.2，FinancialDataMapper类由于实现关系，晓得FinancialDataGateway类，但FinancialDataGateway类并不晓得FinancialDataMapper类。

下一件应该关注每个双线框之间的关系都是单项指向的。这意味着所有组件的关系都是单向的，组件关系如图8.3，这些箭头指向了我们要避免被变化影响的组件。





























